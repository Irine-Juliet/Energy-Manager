{% extends "base.html" %}

{% block title %}A/B Test - Button Variants{% endblock %}

{% block extra_head %}
<!-- Google Analytics 4 Setup -->
<!-- TODO: Replace G-TEST123456 with your real Google Analytics measurement ID -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TEST123456"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TEST123456');
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-12">
    <div class="bg-white rounded-xl shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Team constipated-Lemon</h1>
        
        <!-- Team Members List -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Team Members</h2>
            <ul class="space-y-2">
                {% for member in team_members %}
                <li class="px-4 py-2 bg-gray-50 rounded-lg text-gray-700">{{ member }}</li>
                {% endfor %}
            </ul>
        </div>
        
        <!-- Link to Results -->
        <div class="text-center mb-8">
            <a href="{% url 'abtest_results' %}" 
               class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                ðŸ“Š View Analytics Dashboard
            </a>
        </div>
        
        <!-- Button container - variant will be inserted here -->
        <div id="button-container" class="text-center mb-6">
            <!-- Button will be dynamically inserted here -->
        </div>
        
        <!-- Feedback message -->
        <div id="feedback-message" class="text-center text-green-600 font-semibold mb-6" style="display: none; min-height: 30px;">
            âœ“ Thank you for clicking!
        </div>
        
        <!-- Debug info (optional - remove in production) -->
        <div class="mt-8 bg-gray-50 rounded-lg p-6 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Debug Information</h3>
            <p class="text-gray-700">
                <strong>Current Variant:</strong> 
                <span id="debug-variant" class="ml-2 px-3 py-1 rounded-full text-white font-medium"></span>
            </p>
            <p class="text-sm text-gray-500 mt-2">Check your browser console for GA event logs</p>
        </div>
    </div>
</div>

<script>
// A/B Test Implementation with Google Analytics 4 Tracking + Django Backend

(function() {
    'use strict';
    
    // Variable to store the current variant
    let currentVariant = '';
    let sessionId = '';
    
    /**
     * Initialize the A/B test on page load
     */
    function initABTest() {
        // Generate or retrieve session ID
        sessionId = getOrCreateSessionId();
        
        // Step 1: Track page view
        trackPageView();
        
        // Step 2: Randomly select variant (50/50 split)
        currentVariant = selectVariant();
        
        // Step 3: Track which variant was shown
        trackVariantShown(currentVariant);
        
        // Step 4: Render the button
        renderButton(currentVariant);
        
        // Update debug info
        updateDebugInfo(currentVariant);
    }
    
    /**
     * Get or create a session ID
     */
    function getOrCreateSessionId() {
        let sid = localStorage.getItem('ab_test_session_id');
        if (!sid) {
            sid = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('ab_test_session_id', sid);
        }
        return sid;
    }
    
    /**
     * Get CSRF token from cookies
     */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    /**
     * Send event to Django backend
     */
    function logEventToBackend(eventType, variant) {
        const csrftoken = getCookie('csrftoken');
        
        fetch('/ab-test/log-event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                event_type: eventType,
                variant: variant,
                session_id: sessionId
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Backend Event:', eventType, '- variant:', variant, '- status:', data.status);
        })
        .catch(error => {
            console.error('Backend logging error:', error);
        });
    }
    
    /**
     * Track page view event
     */
    function trackPageView() {
        // Log to GA4
        gtag('event', 'ab_test_page_view', {
            page: '/ab-test'
        });
        console.log('GA Event: ab_test_page_view - page: /ab-test');
        
        // Log to Django backend
        logEventToBackend('page_view', null);
    }
    
    /**
     * Randomly select a variant with 50/50 split (session-persistent)
     * @returns {string} Either 'kudos' or 'thanks'
     */
    function selectVariant() {
        // Check if variant is already stored in localStorage for this session
        let storedVariant = localStorage.getItem('ab_test_variant');
        
        if (storedVariant) {
            console.log('Using stored variant:', storedVariant);
            return storedVariant;
        }
        
        // 50/50 random split using Math.random()
        let newVariant;
        if (Math.random() < 0.5) {
            newVariant = 'kudos';
        } else {
            newVariant = 'thanks';
        }
        
        // Store variant in localStorage for session persistence
        localStorage.setItem('ab_test_variant', newVariant);
        console.log('New variant assigned:', newVariant);
        
        return newVariant;
    }
    
    /**
     * Track that a variant was shown to the user
     * @param {string} variant - The variant that was shown
     */
    function trackVariantShown(variant) {
        // Log to GA4
        gtag('event', 'variant_shown', {
            variant: variant
        });
        console.log('GA Event: variant_shown - variant:', variant);
        
        // Log to Django backend
        logEventToBackend('variant_shown', variant);
    }
    
    /**
     * Track button click event
     * @param {string} variant - The variant that was clicked
     */
    function trackButtonClick(variant) {
        // Log to GA4
        gtag('event', 'button_click', {
            variant: variant
        });
        console.log('GA Event: button_click - variant:', variant);
        
        // Log to Django backend
        logEventToBackend('button_click', variant);
    }
    
    /**
     * Render the button based on the selected variant
     * @param {string} variant - The variant to render
     */
    function renderButton(variant) {
        const container = document.getElementById('button-container');
        
        // Create button element
        const button = document.createElement('button');
        button.id = 'ab-test-button';
        
        // Set button text and styling based on variant
        if (variant === 'kudos') {
            button.textContent = 'kudos';
            button.className = 'px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200';
        } else {
            button.textContent = 'thanks';
            button.className = 'px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200';
        }
        
        // Add click event listener
        button.addEventListener('click', function() {
            handleButtonClick(variant);
        });
        
        // Insert button into container
        container.innerHTML = '';
        container.appendChild(button);
    }
    
    /**
     * Handle button click
     * @param {string} variant - The variant that was clicked
     */
    function handleButtonClick(variant) {
        // Track the click event
        trackButtonClick(variant);
        
        // Show feedback message
        const feedbackMessage = document.getElementById('feedback-message');
        const button = document.getElementById('ab-test-button');
        
        feedbackMessage.style.display = 'block';
        button.disabled = true;
        button.classList.add('opacity-70', 'cursor-not-allowed');
        button.classList.remove('hover:scale-105', 'hover:shadow-xl');
        button.textContent = 'âœ“ Clicked!';
        
        // Optional: Re-enable after 3 seconds
        setTimeout(function() {
            feedbackMessage.style.display = 'none';
            button.disabled = false;
            button.classList.remove('opacity-70', 'cursor-not-allowed');
            button.classList.add('hover:scale-105', 'hover:shadow-xl');
            renderButton(variant); // Re-render with original text
        }, 3000);
    }
    
    /**
     * Update debug information display
     * @param {string} variant - The current variant
     */
    function updateDebugInfo(variant) {
        const debugElement = document.getElementById('debug-variant');
        debugElement.textContent = variant;
        debugElement.className = 'ml-2 px-3 py-1 rounded-full text-white font-medium bg-indigo-600';
    }
    
    // Initialize the A/B test when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initABTest);
    } else {
        initABTest();
    }
})();
</script>
{% endblock %}
