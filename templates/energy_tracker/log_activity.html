{% extends "base.html" %}

{% block title %}Log Activity - Energy Manager{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Log Activity</h1>
    
    <div class="bg-white rounded-lg shadow-md p-8">
        <form method="post" novalidate>
            {% csrf_token %}

            <!-- Activity Name -->
            <div class="mb-4">
                <label for="id_name" class="block text-sm font-medium text-gray-700">{{ form.name.label }}</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.name.errors|striptags }}</p>
                {% endif %}
            </div>

            <!-- Description -->
            <div class="mb-4">
                <label for="id_description" class="block text-sm font-medium text-gray-700">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.description.errors|striptags }}</p>
                {% endif %}
            </div>

            <!-- Modern Unified Date & Time Picker -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">{{ form.activity_date.label }}</label>
                
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg border border-indigo-200 p-6">
                    <!-- Display area showing selected date/time -->
                    <div class="mb-4">
                        <div class="text-center">
                            <p class="text-xs text-gray-600 uppercase tracking-wide mb-2">Event Date & Time</p>
                            <p id="displayDateTime" class="text-3xl font-bold text-indigo-700 whitespace-nowrap">
                                <span id="displayDate">--/--/----</span>
                                <span class="ml-4"><span id="displayTime">--:-- AM</span></span>
                            </p>
                        </div>
                    </div>

                    <!-- Scrollable selector grid -->
                    <!-- Calendar Row -->
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <!-- Traditional Calendar Picker -->
                        <div>
                            <div class="bg-white rounded-lg border border-indigo-300 p-3">
                                <!-- Calendar Header -->
                                <div class="flex items-center justify-between mb-3">
                                    <button type="button" id="prevMonth" class="p-1 hover:bg-indigo-100 rounded">←</button>
                                    <h3 id="monthYear" class="text-sm font-semibold text-gray-700">November 2025</h3>
                                    <button type="button" id="nextMonth" class="p-1 hover:bg-indigo-100 rounded">→</button>
                                </div>

                                <!-- Calendar Grid -->
                                <div class="grid grid-cols-7 gap-3 mb-2">
                                    <!-- Day headers -->
                                    <div class="text-center text-sm font-bold text-gray-600 p-3">Sun</div>
                                    <div class="text-center text-sm font-bold text-gray-600 p-3">Mon</div>
                                    <div class="text-center text-sm font-bold text-gray-600 p-3">Tue</div>
                                    <div class="text-center text-sm font-bold text-gray-600 p-3">Wed</div>
                                    <div class="text-center text-sm font-bold text-gray-600 p-3">Thu</div>
                                    <div class="text-center text-sm font-bold text-gray-600 p-3">Fri</div>
                                    <div class="text-center text-sm font-bold text-gray-600 p-3">Sat</div>
                                    <!-- Days will be generated by JS -->
                                </div>
                                <div id="calendarDays" class="grid grid-cols-7 gap-3">
                                    <!-- Generated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Controls Row -->
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <!-- Hours Dropdown -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-2 uppercase">Hours</label>
                            <div class="relative">
                                <input type="text" id="hoursInput" placeholder="Select hour..." class="w-full px-3 py-2 border border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <div id="hoursDropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border border-indigo-300 rounded-lg shadow-lg max-h-48 overflow-y-auto z-10 hidden">
                                    <!-- Generated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Minutes Dropdown -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-2 uppercase">Minutes</label>
                            <div class="relative">
                                <input type="text" id="minutesInput" placeholder="Select minute..." class="w-full px-3 py-2 border border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <div id="minutesDropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border border-indigo-300 rounded-lg shadow-lg max-h-48 overflow-y-auto z-10 hidden">
                                    <!-- Generated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- AM/PM Dropdown -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-2 uppercase">AM/PM</label>
                            <div class="relative">
                                <input type="text" id="ampmInput" placeholder="Select..." class="w-full px-3 py-2 border border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <div id="ampmDropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border border-indigo-300 rounded-lg shadow-lg z-10 hidden">
                                    <!-- Generated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Options -->
                    <div class="space-y-3 border-t border-indigo-200 pt-4">
                        <!-- All-day Toggle -->
                        <div class="flex items-center justify-between">
                            <label for="allDayToggle" class="text-sm font-medium text-gray-700">All-day event</label>
                            <input type="checkbox" id="allDayToggle" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500" />
                        </div>

                        <!-- Time Zone -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-1 block">Time Zone</label>
                            <select id="timeZoneSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="America/New_York">New York (EST/EDT)</option>
                                <option value="America/Chicago">Chicago (CST/CDT)</option>
                                <option value="America/Denver">Denver (MST/MDT)</option>
                                <option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Hidden datetime-local field for form submission (required by Django form) -->
                <div style="display: none;">
                    {{ form.activity_date }}
                </div>
                <p class="text-sm text-gray-500 mt-2">{{ form.activity_date.help_text }}</p>
                {% if form.activity_date.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.activity_date.errors|striptags }}</p>
                {% endif %}
            </div>

            <!-- Energy Impact Slider -->
            <div class="mb-6">
                <label for="energyRange" class="block text-sm font-medium text-gray-700">How did this make you feel?</label>

                <div class="flex items-center space-x-4 mt-2">
                    <span class="text-sm text-gray-600">-2</span>
                    <input id="energyRange" name="energy_level" type="range" min="-2" max="2" step="1" value="0" class="w-full" aria-describedby="energyDescriptor" />
                    <span class="text-sm text-gray-600">2</span>
                </div>

                <div id="energyDescriptor" class="mt-2 text-sm text-gray-700" aria-live="polite">Neutral</div>

                <!-- Keep original radios for accessibility but hide visually -->
                <div class="sr-only">
                    {{ form.energy_level }}
                </div>
                {% if form.energy_level.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.energy_level.errors|striptags }}</p>
                {% endif %}
            </div>

            <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">Log activity</button>
            </div>
        </form>
    </div>
</div>

<script>
// Modern date/time picker with calendar and searchable dropdowns (split AM/PM)
;(function(){
    const activityInput = document.getElementById('id_activity_date');
    const calendarDays = document.getElementById('calendarDays');
    const monthYearDisplay = document.getElementById('monthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    
    const hoursInput = document.getElementById('hoursInput');
    const hoursDropdown = document.getElementById('hoursDropdown');
    const ampmInput = document.getElementById('ampmInput');
    const ampmDropdown = document.getElementById('ampmDropdown');
    const minutesInput = document.getElementById('minutesInput');
    const minutesDropdown = document.getElementById('minutesDropdown');
    
    const displayDate = document.getElementById('displayDate');
    const displayTime = document.getElementById('displayTime');
    const allDayToggle = document.getElementById('allDayToggle');

    let selectedDate = new Date();
    let displayedMonth = new Date(selectedDate);
    let selectedHour12 = selectedDate.getHours() % 12 || 12; // 1-12 format
    let selectedAmpm = selectedDate.getHours() >= 12 ? 'PM' : 'AM';
    let selectedMinute = selectedDate.getMinutes();
    let isAllDay = false;
    let hoursData = [];
    let ampmData = ['AM', 'PM'];
    let minutesData = [];

    // Format date as mm/dd/yyyy
    function formatDateDisplay(d) {
        const pad = (n) => String(n).padStart(2, '0');
        return `${pad(d.getMonth() + 1)}/${pad(d.getDate())}/${d.getFullYear()}`;
    }

    // Format time as hh:mm AM/PM
    function formatTimeDisplay(h12, ampm, m) {
        const pad = (n) => String(n).padStart(2, '0');
        return `${pad(h12)}:${pad(m)} ${ampm}`;
    }

    // Convert 12-hour format with AM/PM to 24-hour format
    function to24Hour(h12, ampm) {
        let h24 = parseInt(h12);
        if (ampm === 'AM') {
            if (h24 === 12) h24 = 0;
        } else {
            if (h24 !== 12) h24 += 12;
        }
        return h24;
    }

    // Generate calendar for displayed month
    function generateCalendar() {
        const year = displayedMonth.getFullYear();
        const month = displayedMonth.getMonth();

        // Update month/year display
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                            'July', 'August', 'September', 'October', 'November', 'December'];
        monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

        // Clear previous days
        calendarDays.innerHTML = '';

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'p-1';
            calendarDays.appendChild(emptyCell);
        }

        // Add day cells
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('button');
            dayCell.type = 'button';
            dayCell.textContent = day;
            dayCell.className = 'p-2 text-center text-sm rounded-md transition-colors hover:bg-indigo-100';

            const cellDate = new Date(year, month, day);

            // Highlight selected date
            if (cellDate.toDateString() === selectedDate.toDateString()) {
                dayCell.classList.add('bg-indigo-500', 'text-white', 'font-bold');
            }

            dayCell.addEventListener('click', (e) => {
                e.preventDefault();
                selectDate(cellDate);
            });

            calendarDays.appendChild(dayCell);
        }
    }

    // Generate hours data (1-12)
    function generateHoursData() {
        hoursData = [];
        for (let h = 1; h <= 12; h++) {
            hoursData.push({
                display: String(h).padStart(2, '0'),
                value: h
            });
        }
    }

    // Generate minutes data (0-59)
    function generateMinutesData() {
        minutesData = [];
        for (let m = 0; m < 60; m++) {
            minutesData.push({
                display: String(m).padStart(2, '0'),
                value: m
            });
        }
    }

    // Populate hours dropdown
    function populateHoursDropdown(filter = '') {
        hoursDropdown.innerHTML = '';
        hoursData.forEach(hour => {
            if (hour.display.includes(filter)) {
                const option = document.createElement('div');
                option.className = 'px-3 py-2 cursor-pointer hover:bg-indigo-100 transition-colors';
                if (hour.value === selectedHour12) {
                    option.className += ' bg-indigo-500 text-white font-bold';
                }
                option.textContent = hour.display;
                option.addEventListener('click', () => selectHour(hour.value));
                hoursDropdown.appendChild(option);
            }
        });
    }

    // Populate AM/PM dropdown
    function populateAmpmDropdown(filter = '') {
        ampmDropdown.innerHTML = '';
        ampmData.forEach(ap => {
            if (ap.includes(filter.toUpperCase())) {
                const option = document.createElement('div');
                option.className = 'px-3 py-2 cursor-pointer hover:bg-indigo-100 transition-colors';
                if (ap === selectedAmpm) {
                    option.className += ' bg-indigo-500 text-white font-bold';
                }
                option.textContent = ap;
                option.addEventListener('click', () => selectAmpm(ap));
                ampmDropdown.appendChild(option);
            }
        });
    }

    // Populate minutes dropdown
    function populateMinutesDropdown(filter = '') {
        minutesDropdown.innerHTML = '';
        minutesData.forEach(minute => {
            if (minute.display.includes(filter)) {
                const option = document.createElement('div');
                option.className = 'px-3 py-2 cursor-pointer hover:bg-indigo-100 transition-colors';
                if (minute.value === selectedMinute) {
                    option.className += ' bg-indigo-500 text-white font-bold';
                }
                option.textContent = minute.display;
                option.addEventListener('click', () => selectMinute(minute.value));
                minutesDropdown.appendChild(option);
            }
        });
    }

    // Handle date selection
    function selectDate(date) {
        selectedDate = new Date(date);
        generateCalendar();
        updateDisplay();
    }

    // Handle hour selection
    function selectHour(h) {
        selectedHour12 = h;
        hoursInput.value = String(h).padStart(2, '0');
        hoursDropdown.classList.add('hidden');
        updateDisplay();
    }

    // Handle AM/PM selection
    function selectAmpm(ap) {
        selectedAmpm = ap;
        ampmInput.value = ap;
        ampmDropdown.classList.add('hidden');
        updateDisplay();
    }

    // Handle minute selection
    function selectMinute(m) {
        selectedMinute = m;
        minutesInput.value = String(m).padStart(2, '0');
        minutesDropdown.classList.add('hidden');
        updateDisplay();
    }

    // Update display and hidden field
    function updateDisplay() {
        displayDate.textContent = formatDateDisplay(selectedDate);
        displayTime.textContent = formatTimeDisplay(selectedHour12, selectedAmpm, selectedMinute);
        
        // Sync to hidden datetime-local field (YYYY-MM-DDTHH:MM in 24-hour format)
        const h24 = to24Hour(selectedHour12, selectedAmpm);
        const pad = (n) => String(n).padStart(2, '0');
        const dateStr = selectedDate.getFullYear() + '-' + pad(selectedDate.getMonth() + 1) + '-' + pad(selectedDate.getDate());
        activityInput.value = dateStr + 'T' + pad(h24) + ':' + pad(selectedMinute);
    }

    // Month navigation
    prevMonthBtn.addEventListener('click', (e) => {
        e.preventDefault();
        displayedMonth.setMonth(displayedMonth.getMonth() - 1);
        generateCalendar();
    });

    nextMonthBtn.addEventListener('click', (e) => {
        e.preventDefault();
        displayedMonth.setMonth(displayedMonth.getMonth() + 1);
        generateCalendar();
    });

    // Hours dropdown behavior
    hoursInput.addEventListener('focus', () => {
        hoursDropdown.classList.remove('hidden');
        populateHoursDropdown(hoursInput.value);
    });

    hoursInput.addEventListener('input', (e) => {
        populateHoursDropdown(e.target.value);
    });

    // AM/PM dropdown behavior
    ampmInput.addEventListener('focus', () => {
        ampmDropdown.classList.remove('hidden');
        populateAmpmDropdown(ampmInput.value);
    });

    ampmInput.addEventListener('input', (e) => {
        populateAmpmDropdown(e.target.value);
    });

    // Minutes dropdown behavior
    minutesInput.addEventListener('focus', () => {
        minutesDropdown.classList.remove('hidden');
        populateMinutesDropdown(minutesInput.value);
    });

    minutesInput.addEventListener('input', (e) => {
        populateMinutesDropdown(e.target.value);
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#hoursInput') && !e.target.closest('#hoursDropdown')) {
            hoursDropdown.classList.add('hidden');
        }
        if (!e.target.closest('#ampmInput') && !e.target.closest('#ampmDropdown')) {
            ampmDropdown.classList.add('hidden');
        }
        if (!e.target.closest('#minutesInput') && !e.target.closest('#minutesDropdown')) {
            minutesDropdown.classList.add('hidden');
        }
    });

    // Handle all-day toggle
    allDayToggle.addEventListener('change', (e) => {
        isAllDay = e.target.checked;
        if (isAllDay) {
            selectedHour12 = 12;
            selectedAmpm = 'AM';
            selectedMinute = 0;
            hoursInput.value = '';
            ampmInput.value = '';
            minutesInput.value = '';
            hoursInput.disabled = true;
            ampmInput.disabled = true;
            minutesInput.disabled = true;
        } else {
            hoursInput.disabled = false;
            ampmInput.disabled = false;
            minutesInput.disabled = false;
            selectHour(selectedHour12);
            selectAmpm(selectedAmpm);
            selectMinute(selectedMinute);
        }
        updateDisplay();
    });

    // Initialize
    generateCalendar();
    generateHoursData();
    generateMinutesData();
    
    // Always set to current time and date when page loads
    const now = new Date();
    selectedDate = new Date(now);
    selectedHour12 = now.getHours() % 12 || 12;
    selectedAmpm = now.getHours() >= 12 ? 'PM' : 'AM';
    selectedMinute = now.getMinutes();
    displayedMonth = new Date(now);
    
    // Refresh calendar and set initial values
    generateCalendar();
    selectHour(selectedHour12);
    selectMinute(selectedMinute);
    selectAmpm(selectedAmpm);
    updateDisplay();

    // Energy descriptor mapping
    const descriptor = {
        '-2': 'Very Draining',
        '-1': 'Draining',
        '0': 'Neutral',
        '1': 'Energizing',
        '2': 'Flow State / Very Energizing'
    };

    const energyRange = document.getElementById('energyRange');
    const energyDescriptor = document.getElementById('energyDescriptor');
    if (energyRange && energyDescriptor) {
        function updateDesc(){
            const v = energyRange.value;
            energyDescriptor.textContent = descriptor[v] || 'Neutral';
            // Also try to set the hidden radios value for progressive enhancement
            const radios = document.querySelectorAll('input[name="energy_level"][type="radio"]');
            radios.forEach(r=>{ if (r.value === String(v)) r.checked = true; else r.checked = false; });
        }
        energyRange.addEventListener('input', updateDesc);
        // initialize descriptor to current value
        updateDesc();
    }
})();
</script>
</div>
{% endblock %}
