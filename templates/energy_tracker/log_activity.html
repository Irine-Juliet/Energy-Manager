{% extends "base.html" %}
{% block title %}Log Activity - Energy Manager{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50 py-8 px-4">
  <div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <a href="{% url 'dashboard' %}" class="text-indigo-600 hover:text-indigo-800 flex items-center gap-2 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Dashboard
      </a>
    </div>
    
    <!-- Main Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <!-- Title Section -->
      <div class="px-8 py-6 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
        <h1 class="text-3xl font-bold text-gray-900">Log New Activity</h1>
        <p class="mt-2 text-gray-600">Track how this activity affected your energy levels</p>
      </div>
      
      <!-- Form Section -->
      <form method="post" id="activityForm" class="px-8 py-6 space-y-6" novalidate>
        {% csrf_token %}
        
        <!-- Activity Name with Autocomplete -->
        <div class="form-group">
          <label for="activityName" class="block text-sm font-semibold text-gray-700 mb-2">
            Activity Name <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            {{ form.name }}
            <div class="absolute right-3 top-3 text-gray-400 pointer-events-none">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <!-- Autocomplete Dropdown -->
            <div id="autocompleteDropdown" class="absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg border border-gray-200 hidden max-h-64 overflow-y-auto" role="listbox" aria-expanded="false">
              <!-- Populated by JavaScript -->
            </div>
          </div>
          <p id="activityNameHelp" class="mt-1 text-xs text-gray-500">
            Start typing to see suggestions from your previous activities
          </p>
          <p id="activityNameError" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
        </div>
        
        <!-- Date/Time Pickers -->
        <div class="form-group">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            When did this happen? <span class="text-red-500">*</span>
          </label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Date Picker -->
            <div>
              <label for="activityDate" class="block text-xs text-gray-600 mb-1">Date</label>
              <input 
                type="date" 
                id="activityDate" 
                name="activity_date_date"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                aria-describedby="activityDateError"
              />
              <p id="activityDateError" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
            </div>
            
            <!-- Time Picker -->
            <div>
              <label for="activityTime" class="block text-xs text-gray-600 mb-1">Time</label>
              <input 
                type="time" 
                id="activityTime" 
                name="activity_date_time"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                aria-describedby="activityTimeError"
              />
              <p id="activityTimeError" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
            </div>
          </div>
          <!-- Hidden field for Django form -->
          {{ form.activity_date }}
        </div>
        
        <!-- Duration Inputs -->
        <div class="form-group">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            How long did it last? <span class="text-red-500">*</span>
          </label>
          <div class="flex items-center gap-4">
            <div class="flex-1">
              {{ form.duration_hours }}
              <span class="block text-xs text-gray-500 mt-1">hours</span>
            </div>
            <div class="flex-1">
              {{ form.duration_minutes }}
              <span class="block text-xs text-gray-500 mt-1">minutes</span>
            </div>
          </div>
          <p class="mt-2 text-xs text-gray-500">Duration must be between 1 minute and 24 hours</p>
          <p id="durationError" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
        </div>
        
        <!-- Energy Impact Circular Buttons -->
        <div class="form-group">
          <label class="block text-sm font-semibold text-gray-700 mb-3">
            Energy Impact <span class="text-red-500">*</span>
          </label>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" role="radiogroup" aria-label="Energy Impact">
            <!-- Button 1: Very Draining -->
            <button 
              type="button" 
              class="energy-btn" 
              data-value="-2"
              aria-label="Very Draining"
            >
              <div class="energy-btn-inner bg-red-50 hover:bg-red-100 border-2 border-red-200 hover:border-red-400 text-red-700">
                <span class="text-4xl">ðŸ˜«</span>
                <span class="text-2xl font-bold">-2</span>
                <span class="text-xs leading-tight text-center">Very<br/>Draining</span>
              </div>
            </button>
            
            <!-- Button 2: Somewhat Draining -->
            <button 
              type="button" 
              class="energy-btn" 
              data-value="-1"
              aria-label="Somewhat Draining"
            >
              <div class="energy-btn-inner bg-orange-50 hover:bg-orange-100 border-2 border-orange-200 hover:border-orange-400 text-orange-700">
                <span class="text-4xl">ðŸ˜”</span>
                <span class="text-2xl font-bold">-1</span>
                <span class="text-xs leading-tight text-center">Somewhat<br/>Draining</span>
              </div>
            </button>
            
            <!-- Button 3: Somewhat Energizing -->
            <button 
              type="button" 
              class="energy-btn" 
              data-value="1"
              aria-label="Somewhat Energizing"
            >
              <div class="energy-btn-inner bg-green-50 hover:bg-green-100 border-2 border-green-200 hover:border-green-400 text-green-700">
                <span class="text-4xl">ðŸ˜Š</span>
                <span class="text-2xl font-bold">1</span>
                <span class="text-xs leading-tight text-center">Somewhat<br/>Energizing</span>
              </div>
            </button>
            
            <!-- Button 4: Very Energizing -->
            <button 
              type="button" 
              class="energy-btn" 
              data-value="2"
              aria-label="Very Energizing"
            >
              <div class="energy-btn-inner bg-emerald-50 hover:bg-emerald-100 border-2 border-emerald-200 hover:border-emerald-400 text-emerald-700">
                <span class="text-4xl">ðŸš€</span>
                <span class="text-2xl font-bold">2</span>
                <span class="text-xs leading-tight text-center">Very<br/>Energizing</span>
              </div>
            </button>
          </div>
          {{ form.energy_level }}
          <p id="energyError" class="mt-2 text-xs text-red-600 hidden" role="alert"></p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-200">
          <button 
            type="button" 
            id="clearFormBtn"
            class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition"
          >
            Clear Form
          </button>
          <button 
            type="submit"
            class="flex-1 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-sm"
          >
            Log Activity
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Success Toast (hidden by default) -->
<div id="successToast" class="fixed top-4 right-4 z-50 hidden transform transition-all duration-300 ease-out" role="alert" aria-live="polite" aria-atomic="true">
  <div class="bg-white rounded-lg shadow-xl border-l-4 border-green-500 p-4 max-w-md">
    <div class="flex items-start gap-3">
      <!-- Checkmark Icon -->
      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      
      <!-- Message Content -->
      <div class="flex-1 pt-0.5">
        <h3 class="text-sm font-semibold text-gray-900">Activity Logged!</h3>
        <p id="successToastMessage" class="mt-1 text-sm text-gray-600">
          <!-- Populated by JavaScript -->
        </p>
      </div>
      
      <!-- Close Button -->
      <button 
        id="closeSuccessToast" 
        class="flex-shrink-0 text-gray-400 hover:text-gray-600 transition"
        aria-label="Close"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>
</div>

<style>
/* Energy Button Transitions */
.energy-btn {
  transition: transform 0.2s ease;
}

.energy-btn:hover {
  transform: scale(1.05);
}

.energy-btn:active {
  transform: scale(0.98);
}

.energy-btn-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  border-radius: 1rem;
  transition: all 0.2s ease;
  min-height: 140px;
}

/* Toast Slide-in Animation */
@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

#successToast:not(.hidden) {
  animation: slideInRight 0.3s ease-out;
}

#successToast.hiding {
  animation: slideOutRight 0.3s ease-out;
}

/* Checkmark Animation */
@keyframes checkmark {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  50% {
    transform: scale(1.2);
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

#successToast:not(.hidden) svg {
  animation: checkmark 0.4s ease-out 0.1s both;
}
</style>

<script>
// ============================================================================
// ENERGY MANAGER - LOG ACTIVITY FORM
// Complete JavaScript implementation from scratch
// ============================================================================

(function() {
  'use strict';
  
  // ========================================
  // DOM Elements
  // ========================================
  const form = document.getElementById('activityForm');
  const activityNameInput = document.getElementById('activityName');
  const autocompleteDropdown = document.getElementById('autocompleteDropdown');
  const activityDateInput = document.getElementById('activityDate');
  const activityTimeInput = document.getElementById('activityTime');
  const hiddenDateTimeInput = document.getElementById('activity_date');
  const durationHoursInput = document.getElementById('durationHours');
  const durationMinutesInput = document.getElementById('durationMinutes');
  const energyButtons = document.querySelectorAll('.energy-btn');
  const energyLevelInput = document.getElementById('energy_level');
  const clearFormBtn = document.getElementById('clearFormBtn');
  const successToast = document.getElementById('successToast');
  
  // Error message elements
  const activityNameError = document.getElementById('activityNameError');
  const activityDateError = document.getElementById('activityDateError');
  const activityTimeError = document.getElementById('activityTimeError');
  const durationError = document.getElementById('durationError');
  const energyError = document.getElementById('energyError');
  
  // ========================================
  // State Management
  // ========================================
  let selectedEnergyLevel = null;
  let autocompleteTimeout = null;
  let highlightedIndex = -1;
  let suggestions = [];
  
  // ========================================
  // Initialization
  // ========================================
  function init() {
    setCurrentDateTime();
    attachEventListeners();
    setupAccessibility();
  }
  
  // ========================================
  // Date/Time Utilities
  // ========================================
  function setCurrentDateTime() {
    const now = new Date();
    
    // Set date (YYYY-MM-DD format)
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    activityDateInput.value = `${year}-${month}-${day}`;
    
    // Set time (HH:MM format)
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    activityTimeInput.value = `${hours}:${minutes}`;
    
    // Set max date to today
    activityDateInput.max = `${year}-${month}-${day}`;
    
    updateHiddenDateTime();
  }
  
  function updateHiddenDateTime() {
    const date = activityDateInput.value;
    const time = activityTimeInput.value;
    if (date && time) {
      hiddenDateTimeInput.value = `${date}T${time}`;
    }
  }
  
  function validateDateTime() {
    const selectedDateTime = new Date(activityDateInput.value + 'T' + activityTimeInput.value);
    const now = new Date();
    
    if (selectedDateTime > now) {
      showError(activityDateError, 'Cannot log activities in the future');
      return false;
    }
    
    hideError(activityDateError);
    return true;
  }
  
  // ========================================
  // Autocomplete Functionality
  // ========================================
  function handleAutocompleteInput(e) {
    const searchTerm = e.target.value.trim();
    
    // Clear timeout to implement debouncing
    clearTimeout(autocompleteTimeout);
    
    if (searchTerm.length === 0) {
      hideAutocomplete();
      return;
    }
    
    // Debounce: wait 300ms after user stops typing
    autocompleteTimeout = setTimeout(() => {
      fetchSuggestions(searchTerm);
    }, 300);
  }
  
  async function fetchSuggestions(searchTerm) {
    try {
      const response = await fetch(`/autocomplete-activities/?q=${encodeURIComponent(searchTerm)}`);
      
      if (!response.ok) throw new Error('Failed to fetch suggestions');
      
      const data = await response.json();
      suggestions = data.suggestions || [];
      renderSuggestions();
    } catch (error) {
      console.error('Autocomplete error:', error);
      suggestions = [];
      hideAutocomplete();
    }
  }
  
  function renderSuggestions() {
    autocompleteDropdown.innerHTML = '';
    
    if (suggestions.length === 0) {
      const noResults = document.createElement('div');
      noResults.className = 'px-4 py-3 text-sm text-gray-500 text-center';
      noResults.textContent = 'No matching activities found';
      autocompleteDropdown.appendChild(noResults);
      showAutocomplete();
      return;
    }
    
    suggestions.forEach((suggestion, index) => {
      const item = document.createElement('div');
      item.className = 'px-4 py-3 cursor-pointer hover:bg-indigo-50 transition flex items-center justify-between group';
      item.setAttribute('data-index', index);
      item.setAttribute('role', 'option');
      
      const nameContainer = document.createElement('div');
      nameContainer.className = 'flex items-center gap-2';
      
      if (suggestion.is_top_5) {
        const badge = document.createElement('span');
        badge.textContent = 'â­';
        badge.className = 'text-sm';
        badge.title = 'Frequently used';
        nameContainer.appendChild(badge);
      }
      
      const name = document.createElement('span');
      name.className = 'text-gray-900 font-medium';
      name.textContent = suggestion.name;
      nameContainer.appendChild(name);
      
      const count = document.createElement('span');
      count.className = 'text-xs text-gray-500';
      count.textContent = `${suggestion.count} times`;
      
      item.appendChild(nameContainer);
      item.appendChild(count);
      
      item.addEventListener('click', () => selectSuggestion(suggestion.name));
      item.addEventListener('mouseenter', () => highlightSuggestion(index));
      
      autocompleteDropdown.appendChild(item);
    });
    
    showAutocomplete();
    highlightedIndex = -1;
  }
  
  function selectSuggestion(name) {
    activityNameInput.value = name;
    hideAutocomplete();
    activityDateInput.focus();
  }
  
  function highlightSuggestion(index) {
    const items = autocompleteDropdown.querySelectorAll('[data-index]');
    items.forEach((item, i) => {
      if (i === index) {
        item.classList.add('bg-indigo-50');
        item.setAttribute('aria-selected', 'true');
      } else {
        item.classList.remove('bg-indigo-50');
        item.setAttribute('aria-selected', 'false');
      }
    });
    highlightedIndex = index;
  }
  
  function handleAutocompleteKeyboard(e) {
    if (!autocompleteDropdown.classList.contains('hidden')) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const newIndex = Math.min(highlightedIndex + 1, suggestions.length - 1);
        highlightSuggestion(newIndex);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const newIndex = Math.max(highlightedIndex - 1, 0);
        highlightSuggestion(newIndex);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (highlightedIndex >= 0 && highlightedIndex < suggestions.length) {
          selectSuggestion(suggestions[highlightedIndex].name);
        }
      } else if (e.key === 'Escape') {
        hideAutocomplete();
      }
    }
  }
  
  function showAutocomplete() {
    autocompleteDropdown.classList.remove('hidden');
    autocompleteDropdown.setAttribute('aria-expanded', 'true');
  }
  
  function hideAutocomplete() {
    autocompleteDropdown.classList.add('hidden');
    autocompleteDropdown.setAttribute('aria-expanded', 'false');
    highlightedIndex = -1;
  }
  
  // ========================================
  // Energy Level Selection
  // ========================================
  function handleEnergyButtonClick(e) {
    e.preventDefault();
    const button = e.currentTarget;
    const value = button.getAttribute('data-value');
    
    // Remove selected state from all buttons
    energyButtons.forEach(btn => {
      const inner = btn.querySelector('.energy-btn-inner');
      inner.classList.remove('ring-4', 'ring-offset-2');
      
      // Remove color-specific rings
      inner.classList.remove('ring-red-400', 'ring-orange-400', 'ring-green-400', 'ring-emerald-400');
    });
    
    // Add selected state to clicked button
    const inner = button.querySelector('.energy-btn-inner');
    inner.classList.add('ring-4', 'ring-offset-2');
    
    // Add color-specific ring based on value
    const ringColors = {
      '-2': 'ring-red-400',
      '-1': 'ring-orange-400',
      '1': 'ring-green-400',
      '2': 'ring-emerald-400'
    };
    inner.classList.add(ringColors[value]);
    
    // Update hidden input and state
    selectedEnergyLevel = value;
    energyLevelInput.value = value;
    hideError(energyError);
  }
  
  // ========================================
  // Form Validation
  // ========================================
  function validateForm() {
    let isValid = true;
    
    // Validate activity name
    const activityName = activityNameInput.value.trim();
    if (!activityName) {
      showError(activityNameError, 'Activity name is required');
      isValid = false;
    } else if (activityName.length > 100) {
      showError(activityNameError, 'Activity name cannot exceed 100 characters');
      isValid = false;
    } else {
      hideError(activityNameError);
    }
    
    // Validate date/time
    if (!validateDateTime()) {
      isValid = false;
    }
    
    // Validate duration
    const hours = parseInt(durationHoursInput.value) || 0;
    const minutes = parseInt(durationMinutesInput.value) || 0;
    const totalMinutes = hours * 60 + minutes;
    
    if (totalMinutes < 1) {
      showError(durationError, 'Activity must be at least 1 minute');
      isValid = false;
    } else if (totalMinutes > 1440) {
      showError(durationError, 'Activity cannot exceed 24 hours');
      isValid = false;
    } else {
      hideError(durationError);
    }
    
    // Validate energy level
    if (!selectedEnergyLevel) {
      showError(energyError, 'Please select an energy level');
      isValid = false;
    } else {
      hideError(energyError);
    }
    
    return isValid;
  }
  
  function showError(element, message) {
    element.textContent = message;
    element.classList.remove('hidden');
    
    // Add red border to associated input
    const inputId = element.id.replace('Error', '');
    const input = document.getElementById(inputId);
    if (input) {
      input.classList.add('border-red-500', 'focus:ring-red-500');
    }
  }
  
  function hideError(element) {
    element.textContent = '';
    element.classList.add('hidden');
    
    // Remove red border from associated input
    const inputId = element.id.replace('Error', '');
    const input = document.getElementById(inputId);
    if (input) {
      input.classList.remove('border-red-500', 'focus:ring-red-500');
    }
  }
  
  // ========================================
  // Form Submission
  // ========================================
  function handleFormSubmit(e) {
    e.preventDefault(); // Always prevent default to handle via AJAX
    
    // Update hidden datetime field
    updateHiddenDateTime();
    
    // Validate form
    if (!validateForm()) {
      // Scroll to first error
      const firstError = document.querySelector('.text-red-600:not(.hidden)');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return false;
    }
    
    // Form is valid, submit via AJAX
    submitFormViaAjax();
  }
  
  async function submitFormViaAjax() {
    try {
      const formData = new FormData(form);
      
      const response = await fetch(form.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        // SUCCESS: Show toast, clear form, stay on page
        const activityName = activityNameInput.value.trim();
        const hours = parseInt(durationHoursInput.value) || 0;
        const minutes = parseInt(durationMinutesInput.value) || 0;
        const duration = formatDuration(hours, minutes);
        
        showSuccessToast(activityName, duration, selectedEnergyLevel);
        resetFormToDefaults();
      } else {
        // Server returned validation errors
        displayServerErrors(result.errors);
      }
    } catch (error) {
      console.error('Form submission error:', error);
      alert('An error occurred while saving the activity. Please try again.');
    }
  }
  
  function formatDuration(hours, minutes) {
    const parts = [];
    if (hours > 0) parts.push(`${hours}h`);
    if (minutes > 0) parts.push(`${minutes}m`);
    return parts.join(' ') || '0m';
  }
  
  function resetFormToDefaults() {
    // Reset all fields to initial state
    activityNameInput.value = '';
    setCurrentDateTime();
    durationHoursInput.value = '0';
    durationMinutesInput.value = '0';
    
    // Deselect all energy buttons
    energyButtons.forEach(btn => {
      const inner = btn.querySelector('.energy-btn-inner');
      inner.classList.remove('ring-4', 'ring-offset-2', 'ring-red-400', 'ring-orange-400', 'ring-green-400', 'ring-emerald-400');
    });
    selectedEnergyLevel = null;
    energyLevelInput.value = '';
    
    // Clear all errors
    hideError(activityNameError);
    hideError(activityDateError);
    hideError(activityTimeError);
    hideError(durationError);
    hideError(energyError);
    
    // Hide autocomplete
    hideAutocomplete();
    
    // Focus on activity name input for next entry
    activityNameInput.focus();
  }
  
  function displayServerErrors(errors) {
    // Display server-side validation errors
    if (errors.name) showError(activityNameError, errors.name[0]);
    if (errors.activity_date) showError(activityDateError, errors.activity_date[0]);
    if (errors.duration_hours || errors.duration_minutes) {
      showError(durationError, errors.duration_hours?.[0] || errors.duration_minutes?.[0]);
    }
    if (errors.energy_level) showError(energyError, errors.energy_level[0]);
  }
  
  // ========================================
  // Clear Form
  // ========================================
  function handleClearForm(e) {
    e.preventDefault();
    
    // Check if form has any data
    const hasData = activityNameInput.value.trim() ||
                   durationHoursInput.value !== '0' ||
                   durationMinutesInput.value !== '0' ||
                   selectedEnergyLevel;
    
    if (hasData) {
      const confirmed = confirm('Are you sure you want to clear all form fields?');
      if (!confirmed) return;
    }
    
    resetFormToDefaults();
  }
  
  // ========================================
  // Success Toast
  // ========================================
  function showSuccessToast(activityName, duration, energyLevel) {
    const message = document.getElementById('successToastMessage');
    
    const energyLabels = {
      '-2': 'Very Draining',
      '-1': 'Somewhat Draining',
      '1': 'Somewhat Energizing',
      '2': 'Very Energizing'
    };
    
    message.textContent = `${activityName} â€¢ ${duration} â€¢ ${energyLabels[energyLevel]}`;
    
    // Show toast with animation
    successToast.classList.remove('hidden', 'hiding');
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
      hideSuccessToast();
    }, 3000);
  }
  
  function hideSuccessToast() {
    // Add hiding class for slide-out animation
    successToast.classList.add('hiding');
    
    // After animation completes, hide the element
    setTimeout(() => {
      successToast.classList.add('hidden');
      successToast.classList.remove('hiding');
    }, 300);
  }
  
  // ========================================
  // Event Listeners
  // ========================================
  function attachEventListeners() {
    // Autocomplete
    activityNameInput.addEventListener('input', handleAutocompleteInput);
    activityNameInput.addEventListener('keydown', handleAutocompleteKeyboard);
    activityNameInput.addEventListener('focus', () => {
      if (activityNameInput.value.trim()) {
        handleAutocompleteInput({ target: activityNameInput });
      }
    });
    
    // Date/Time
    activityDateInput.addEventListener('change', updateHiddenDateTime);
    activityTimeInput.addEventListener('change', updateHiddenDateTime);
    activityDateInput.addEventListener('blur', validateDateTime);
    activityTimeInput.addEventListener('blur', validateDateTime);
    
    // Energy buttons
    energyButtons.forEach(btn => {
      btn.addEventListener('click', handleEnergyButtonClick);
    });
    
    // Clear form button
    clearFormBtn.addEventListener('click', handleClearForm);
    
    // Form submission
    form.addEventListener('submit', handleFormSubmit);
    
    // Success toast close button
    const closeToastBtn = document.getElementById('closeSuccessToast');
    if (closeToastBtn) {
      closeToastBtn.addEventListener('click', hideSuccessToast);
    }
    
    // Close autocomplete when clicking outside
    document.addEventListener('click', (e) => {
      if (!activityNameInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
        hideAutocomplete();
      }
    });
  }
  
  // ========================================
  // Accessibility
  // ========================================
  function setupAccessibility() {
    // Set ARIA attributes
    activityNameInput.setAttribute('aria-autocomplete', 'list');
    activityNameInput.setAttribute('aria-controls', 'autocompleteDropdown');
    autocompleteDropdown.setAttribute('role', 'listbox');
    
    // Add character counter for activity name
    activityNameInput.addEventListener('input', () => {
      const charCount = activityNameInput.value.length;
      const helpText = document.getElementById('activityNameHelp');
      if (charCount > 0) {
        helpText.textContent = `${charCount}/100 characters`;
      } else {
        helpText.textContent = 'Start typing to see suggestions from your previous activities';
      }
    });
  }
  
  // ========================================
  // Initialize on DOM ready
  // ========================================
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
})();
</script>
{% endblock %}
