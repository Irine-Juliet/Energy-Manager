{% extends 'base.html' %}

{% block title %}Dashboard - Energy Manager{% endblock %}

{% block extra_head %}
        <!-- Chart.js and date adapter -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
        <style>
                .insights-panel::-webkit-scrollbar { width: 6px; }
                .insights-panel::-webkit-scrollbar-track { background: #f3f4f6; }
                .insights-panel::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
                .insights-panel::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        </style>
    {% endblock %}

    {% block content %}
    <div class="bg-gray-50 rounded-lg shadow-sm p-6">

        

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Today's Energy Flow</h2>
                <div class="h-80 md:h-96">
                    <canvas id="energyOverTimeChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow flex flex-col items-center justify-center h-full min-h-[200px] lg:min-h-0">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Current Status</h2>
                <div id="currentEnergyStatus" class="flex flex-col items-center justify-center text-center">
                    <p class="mt-4 text-xl font-medium text-gray-500">Calculating...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Time per Energy State</h2>
                <div class="h-96">
                    <canvas id="hoursPerCategoryChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Insights</h2>
                <div id="insightsPanel" class="insights-panel h-96 overflow-y-auto">
                    <div class="flex flex-col items-center justify-center h-full text-gray-500">
                        <p class="text-center">Hover over the bar chart<br/>to see details.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
    {% endblock %}

    {% block extra_js %}
        <script>
            // Server-injected data
            const activityLog = {{ activity_points|safe }} || [];
            const hourlyAvg = {{ hourly_avg|safe }} || Array(24).fill(null);
            // Ensure we always have all five buckets available client-side (-2..2)
            const hoursPerCategory = Object.assign(
                {'-2':0,'-1':0,'0':0,'1':0,'2':0},
                {{ hours_per_category|default:"{}"|safe }}
            );
            console.debug('hoursPerCategory (final):', hoursPerCategory);
            const serverAvg = Number({{ today_avg|default:0 }});

            const ENERGY_LEVELS = {
                '-2': { label: 'Very Draining', color: 'rgba(185, 28, 28, 0.85)', emoji: 'ðŸª«' },
                '-1': { label: 'Somewhat Draining', color: 'rgba(239, 68, 68, 0.7)', emoji: 'ðŸ˜Ÿ' },
                '0': { label: 'Neutral', color: 'rgba(107, 114, 128, 0.7)', emoji: 'ðŸ˜¶' },
                '1': { label: 'Somewhat Energizing', color: 'rgba(34, 197, 94, 0.7)', emoji: 'ðŸ˜ƒ' },
                '2': { label: 'Flow State', color: 'rgba(59, 130, 246, 0.7)', emoji: 'ðŸ¤©' },
            };

            Chart.defaults.color = '#111827';

            // Debug: expose data to console for quick inspection
            console.debug('dashboard data -> activityLog, hourlyAvg, hoursPerCategory, serverAvg, Chart:', { activityLog: activityLog, hourlyAvg: hourlyAvg, hoursPerCategory: hoursPerCategory, serverAvg: serverAvg, ChartAvailable: (typeof Chart !== 'undefined') });

            document.addEventListener('DOMContentLoaded', () => {
                const ctxLine = document.getElementById('energyOverTimeChart')?.getContext('2d');
                const ctxBar = document.getElementById('hoursPerCategoryChart')?.getContext('2d');
                const statusEl = document.getElementById('currentEnergyStatus');
                const insightsEl = document.getElementById('insightsPanel');

                if (!statusEl || !insightsEl) return;

                // Update Current Status immediately so UI shows even if charts fail
                let icon = ENERGY_LEVELS['0'].emoji, text = 'Feeling Neutral', colorClass='text-gray-500';
                if (serverAvg > 1.25) { icon = ENERGY_LEVELS['2'].emoji; text = 'In the Flow!'; colorClass='text-blue-500'; }
                else if (serverAvg > 0.25) { icon = ENERGY_LEVELS['1'].emoji; text = 'Feeling Energized'; colorClass='text-green-500'; }
                else if (serverAvg < -0.25) { icon = ENERGY_LEVELS['-1'].emoji; text = 'Feeling Drained'; colorClass='text-red-500'; }
                statusEl.innerHTML = `<div class="flex flex-col items-center"> <div class="text-6xl">${icon}</div><p class="mt-4 text-2xl font-semibold ${colorClass}">${text}</p><p class="text-sm text-gray-500 mt-1">Average: ${serverAvg.toFixed(2)}</p></div>`;

                // Prepare data for charts
                // Map internal energy values (-2, -1, 1, 2) to chart scale 1..4 for this chart:
                // 2 -> 4 (very energizing), 1 -> 3 (somewhat energizing), -1 -> 2 (somewhat draining), -2 -> 1 (very draining)
                const energyMap = { '2': 4, '1': 3, '-1': 2, '-2': 1 };
                const lineData = activityLog.map(e => {
                    const raw = Number(e.energy);
                    const mapped = energyMap.hasOwnProperty(String(raw)) ? energyMap[String(raw)] : null;
                    return { x: new Date(e.startTime).getTime(), y: mapped };
                }).filter(d => d.y !== null).sort((a,b)=>a.x-b.x);

                // Bar chart data: enforce fixed display order (very energizing â†’ somewhat energizing â†’ somewhat draining â†’ very draining)
                const orderedKeys = ['2','1','-1','-2'];
                const displayLabelMap = { '2': 'Very Energizing', '1': 'Somewhat Energizing', '-1': 'Somewhat Draining', '-2': 'Very Draining' };
                const barLabels = orderedKeys.map(k => displayLabelMap[k] || (ENERGY_LEVELS[k] ? ENERGY_LEVELS[k].label : k));
                const barData = orderedKeys.map(k => Number(hoursPerCategory[k] || 0));
                // Make the key values obvious in the console so they aren't missed by filters
                console.warn('DEBUG: hoursPerCategory (client):', hoursPerCategory);
                try { console.warn('DEBUG: hoursPerCategory (json):', JSON.stringify(hoursPerCategory)); } catch(e) { console.warn('DEBUG stringify failed', e); }
                console.warn('DEBUG: barLabels:', barLabels);
                try { console.warn('DEBUG: barLabels (json):', JSON.stringify(barLabels)); } catch(e) { /* ignore */ }
                console.warn('DEBUG: barData:', barData);
                try { console.warn('DEBUG: barData (json):', JSON.stringify(barData)); } catch(e) { /* ignore */ }
                // Log mapping of orderedKeys -> label -> value for clarity
                orderedKeys.forEach((k, i) => console.warn(`DEBUG MAPPING: key=${k} label=${barLabels[i]} value=${barData[i]}`));

                // If debug param present, render an on-page debug panel to make it obvious
                try {
                    const params = new URLSearchParams(window.location.search);
                    if (params.get('debug') === '1') {
                        const dbg = document.createElement('div');
                        dbg.style.position = 'fixed';
                        dbg.style.right = '12px';
                        dbg.style.bottom = '12px';
                        dbg.style.zIndex = 9999;
                        dbg.style.background = 'rgba(255,255,255,0.95)';
                        dbg.style.border = '1px solid rgba(0,0,0,0.08)';
                        dbg.style.padding = '10px';
                        dbg.style.borderRadius = '8px';
                        dbg.style.maxWidth = '320px';
                        dbg.style.fontSize = '13px';
                        dbg.innerHTML = `<strong>Dashboard Debug</strong><br/><pre style="white-space:pre-wrap;word-break:break-word;margin:6px 0;">hoursPerCategory: ${JSON.stringify(hoursPerCategory, null, 2)}\n\nbarLabels: ${JSON.stringify(barLabels)}\n\nbarData: ${JSON.stringify(barData)}</pre>`;
                        document.body.appendChild(dbg);
                    }
                } catch(e) { console.warn('debug panel error', e); }
                const barColors = orderedKeys.map(k => (ENERGY_LEVELS[k] ? ENERGY_LEVELS[k].color : 'rgba(156,163,175,0.7)'));
                const maxHours = barData.length ? Math.max(...barData) : 0;
                const xAxisMax = Math.max(1, Math.min(8, Math.ceil(maxHours) + 1));

                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not available â€” charts will not render.');
                } else {
                    // Line chart
                    if (ctxLine) {
                        // Plugin: draw emoji labels to the left of the y-axis so they render consistently (for mapped scale 4..1)
                        const emojiMap = { '4':'ðŸ¤©', '3':'ðŸ˜ƒ', '2':'ðŸ˜Ÿ', '1':'ðŸª«' };
                        const emojiAxisPlugin = {
                            id: 'emojiAxisPlugin',
                            afterDraw: (chart) => {
                                try {
                                    // Only draw emojis for the line chart canvas to avoid affecting
                                    // the bar chart y-axis labels (we want words there).
                                    if (!chart?.canvas?.id || chart.canvas.id !== 'energyOverTimeChart') return;
                                    const yScale = chart.scales?.y;
                                    if (!yScale) return;
                                    const ctx = chart.ctx;
                                    ctx.save();
                                    ctx.fillStyle = '#111827';
                                    ctx.font = '22px sans-serif';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    const left = chart.chartArea.left;
                                    const x = left - 20; // draw left of chart area (reduced padding)
                                    // Draw the 4 mapped ticks (4,3,2,1)
                                    ['4','3','2','1'].forEach(k => {
                                        const val = Number(k);
                                        const y = yScale.getPixelForValue(val);
                                        if (typeof y === 'number' && !Number.isNaN(y)) {
                                            ctx.fillText(emojiMap[k] || '', x, y);
                                        }
                                    });
                                    ctx.restore();
                                } catch (e) {
                                    console.error('emojiAxisPlugin error', e);
                                }
                            }
                        };

                        try { Chart.register(emojiAxisPlugin); } catch (e) { /* ignore if already registered */ }

                        try {
                            new Chart(ctxLine, {
                                type: 'line',
                                data: { datasets: [{ label: 'Energy Level', data: lineData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.2)', fill: true, tension:0.4, pointRadius:4 }]},
                                options: {
                                    responsive:true, maintainAspectRatio:false,
                                    // Increase top padding so the topmost markers are not clipped
                                    layout: { padding: { left: 20, top: 48 } },
                                    scales: {
                                        x: { type: 'time', time: { unit: 'hour', displayFormats:{hour:'HH:00'}, tooltipFormat:'HH:mm' }, min: new Date().setHours(0,0,0,0), max: new Date().setHours(23,59,59,999) },
                                        y: {
                                            // Use a 0..4 scale but add a small headroom so markers at 4 aren't clipped
                                            min: 0, max: 4.2,
                                            ticks: { stepSize: 1, color: '#111827', font: { size: 14 }, autoSkip: false, callback: function(value) { return ''; } },
                                            grid: { color: function(ctx) { try { const v = Number(ctx.tick && ctx.tick.value); return v === 0 ? 'transparent' : 'rgba(0,0,0,0.06)'; } catch(e) { return 'rgba(0,0,0,0.06)'; } } },
                                            beginAtZero: true,
                                            afterBuildTicks: function(scale) {
                                                if (scale.ticks && Array.isArray(scale.ticks)) {
                                                    scale.ticks = scale.ticks.filter(t => Number(t.value) !== 0);
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        } catch (err) {
                            console.error('Error rendering line chart:', err);
                        }
                    }

                    // Bar chart
                    if (ctxBar) {
                        try {
                            new Chart(ctxBar, {
                                type: 'bar',
                                data: { labels: barLabels, datasets: [{ data: barData, backgroundColor: barColors }] },
                                options: {
                                    indexAxis: 'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} },
                                    scales: { x: { beginAtZero:true, max: xAxisMax, ticks:{ stepSize: 1 } } },
                                    onHover: (evt, elems) => { const canvas = evt.native.target; if (elems.length) { canvas.style.cursor = 'pointer'; updateInsights(orderedKeys[elems[0].index], barData[elems[0].index]); } else { canvas.style.cursor = 'default'; } },
                                    onClick: (evt, elems) => { if (elems.length) updateInsights(orderedKeys[elems[0].index], barData[elems[0].index]); }
                                }
                            });
                        } catch (err) {
                            console.error('Error rendering bar chart:', err);
                        }
                    }
                }

                function updateInsights(key, hours) {
                    // Use the standardized display labels for insights regardless of ENERGY_LEVELS' internal label text
                    const displayLabel = displayLabelMap[key] || (ENERGY_LEVELS[key] ? ENERGY_LEVELS[key].label : key);
                    const color = (ENERGY_LEVELS[key] && ENERGY_LEVELS[key].color) ? ENERGY_LEVELS[key].color : 'rgba(107,114,128,0.7)';
                    const emoji = (ENERGY_LEVELS[key] && ENERGY_LEVELS[key].emoji) ? ENERGY_LEVELS[key].emoji : 'ðŸ˜¶';
                    const acts = activityLog.filter(a=>String(a.energy)===String(key)).map(a=>`<li class="py-2 px-3 bg-gray-100 rounded-lg mb-2"><span class="font-medium">${a.name}</span> <span class="text-sm text-gray-500"> (${new Date(a.startTime).toLocaleTimeString()})</span></li>`).join('');
                    insightsEl.innerHTML = `
                        <div class="flex items-center gap-3 mb-4">
                            <div class="text-3xl">${emoji}</div>
                            <h3 class="text-2xl font-bold" style="color:${color}">${displayLabel}</h3>
                        </div>
                        <p class="text-4xl font-light mb-6">${hours} <span class="text-lg">hours logged</span></p>
                        <h4 class="text-lg font-semibold mb-3 text-gray-800">Logged Activities</h4>
                        <ul class="space-y-2">${acts.length?acts:'<li class="text-gray-500">No activities logged for this state.</li>'}</ul>`;
                }

            });
                </script>
        {% endblock %}