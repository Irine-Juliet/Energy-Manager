<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Energy Manager{% endblock %}</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50" id="page-body">
        <script>
            // Apply theme from cookie if present. This avoids template errors for missing profiles.
            (function(){
                function getCookie(name){
                    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                    return v ? v.pop() : null;
                }
                const theme = getCookie('theme');
                const body = document.getElementById('page-body');
                if(theme === 'dark'){
                    body.className = 'bg-gray-900 text-white';
                } else {
                    // default/light
                    body.className = 'bg-gray-50 text-gray-900';
                }
            })();
        </script>
        <style>
            /* Make common Tailwind gray text utilities readable in dark mode */
            body.bg-gray-900 .text-gray-900 { color: #f8fafc !important; }
            body.bg-gray-900 .text-gray-800 { color: #f1f5f9 !important; }
            body.bg-gray-900 .text-gray-700 { color: #e2e8f0 !important; }
            body.bg-gray-900 .text-gray-600 { color: #cbd5e1 !important; }
            body.bg-gray-900 .text-gray-500 { color: #9ca3af !important; }
            body.bg-gray-900 .text-gray-400 { color: #94a3b8 !important; }
            body.bg-gray-900 .text-gray-300 { color: #cbd5e1 !important; }
        </style>
    {% if user.is_authenticated %}
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-bold text-indigo-600">âš¡ Energy Manager</h1>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="{% url 'homepage' %}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Home
                        </a>
                        <a href="{% url 'dashboard' %}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Dashboard
                        </a>
                        <a href="{% url 'log_activity' %}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Log Activity
                        </a>
                        <a href="{% url 'activity_history' %}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            History
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="relative inline-block text-left">
                        <button id="user-menu-button" type="button" aria-haspopup="true" aria-expanded="false" class="inline-flex items-center justify-center rounded-md px-3 py-2 text-sm font-medium text-indigo-700 hover:text-indigo-800 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <span class="mr-2 font-medium">{{ user.username }}</span>
                            <svg class="h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.293l3.71-4.06a.75.75 0 111.12 1L10.56 13.28a.75.75 0 01-1.12 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                            </svg>
                        </button>

                        <div id="user-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button">
                            <div class="py-1">
                                <a href="{% url 'settings' %}" class="block px-4 py-2 text-sm text-indigo-700 hover:bg-indigo-50" role="menuitem">Settings</a>
                                <a href="{% url 'account' %}" class="block px-4 py-2 text-sm text-indigo-700 hover:bg-indigo-50" role="menuitem">Account</a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-indigo-700 hover:bg-indigo-50" role="menuitem">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        {% for message in messages %}
        <div class="{% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% else %}bg-blue-100 border-blue-400 text-blue-700{% endif %} border px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Content -->
    <main class="{% if user.is_authenticated %}max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8{% endif %}">
        {% block content %}{% endblock %}
    </main>

    {% block extra_js %}{% endblock %}
        <script>
            // Dropdown toggle for user menu: open on click, close on outside click or Escape.
            (function(){
                const btn = document.getElementById('user-menu-button');
                const menu = document.getElementById('user-menu');
                if(!btn || !menu) return;

                function isOpen(){ return !menu.classList.contains('hidden'); }

                function openMenu(){ menu.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); }
                function closeMenu(){ menu.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); }

                btn.addEventListener('click', function(e){
                    e.stopPropagation();
                    if(isOpen()) closeMenu(); else openMenu();
                });

                // Close when clicking outside
                document.addEventListener('click', function(e){
                    if(!menu.contains(e.target) && !btn.contains(e.target)){
                        closeMenu();
                    }
                });

                // Close on Escape
                document.addEventListener('keydown', function(e){
                    if(e.key === 'Escape') closeMenu();
                });
            })();
        </script>
</body>
</html>
