name: Django CI Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**', 'bugfix/**', 'bug-fix-for-history-and-log-activity', 'githubtest-development', 'testing-refactor' ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  SECRET_KEY: 'test-secret-key-for-ci-do-not-use-in-production'
  DEBUG: 'False'
  ALLOWED_HOSTS: 'localhost,127.0.0.1'
  TZ: 'America/New_York'

jobs:
  # Job 1: Code Quality Checks
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Linting Tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black flake8 isort
      
      - name: Run Ruff Linting
        run: ruff check . --output-format=github
        continue-on-error: true
      
      - name: Check Code Formatting (Black)
        run: black --check --diff .
        continue-on-error: true
      
      - name: Check Import Sorting (isort)
        run: isort --check-only --diff .
        continue-on-error: true
      
      - name: Run Flake8
        run: flake8 . --count --show-source --statistics
        continue-on-error: true

  # Job 2: Security Scanning
  security:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety pip-audit
      
      - name: Run Safety Check
        run: safety check --json
        continue-on-error: true
      
      - name: Run Pip Audit
        run: pip-audit
        continue-on-error: true
      
      - name: Generate Security Report
        if: always()
        run: |
          echo "## Security Scan Results" > security-report.md
          echo "### Safety Check" >> security-report.md
          safety check --json >> security-report.md || true
          echo "### Pip Audit" >> security-report.md
          pip-audit >> security-report.md || true
      
      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: security-report.md
          retention-days: 90

  # Job 3: Django System Checks
  django-checks:
    name: Django System Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Django System Check
        run: python manage.py check --deploy
        env:
          SECRET_KEY: ${{ env.SECRET_KEY }}
      
      - name: Check for Migration Issues
        run: python manage.py makemigrations --check --dry-run --no-input
        env:
          SECRET_KEY: ${{ env.SECRET_KEY }}

  # Job 4: Database Migrations
  migrations:
    name: Test Database Migrations
    runs-on: ubuntu-latest
    env:
      DJANGO_SETTINGS_MODULE: energy_manager.settings
      DATABASE_URL: 'sqlite:///test_db.sqlite3'
      SECRET_KEY: 'test-secret-key-for-ci-do-not-use-in-production'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Migrations
        run: python manage.py migrate --no-input
      
      - name: Create Test Superuser
        run: |
          python - <<'PY'
          import os
          os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'energy_manager.settings')
          import django
          django.setup()
          from django.contrib.auth import get_user_model
          User = get_user_model()
          if not User.objects.filter(username='admin').exists():
              User.objects.create_superuser('admin', 'admin@test.com', 'testpass123')
          PY

  # Job 5: Unit & Integration Tests
  test:
    name: Run Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    env:
      DJANGO_SETTINGS_MODULE: energy_manager.settings
      DATABASE_URL: 'sqlite:///test_db.sqlite3'
      SECRET_KEY: 'test-secret-key-for-ci-do-not-use-in-production'
      TZ: 'America/New_York'
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run Migrations
        run: python manage.py migrate --no-input
      
      - name: Run Tests with Coverage
        run: |
          pytest --verbose --create-db --cov=energy_tracker --cov-report=term-missing --cov-report=html --cov-report=xml --cov-fail-under=0
      
      - name: Upload Coverage HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: htmlcov/
          retention-days: 30
      
      - name: Upload Coverage XML
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-xml
          path: coverage.xml
          retention-days: 30
      
      - name: Upload Test Database
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-database-${{ matrix.python-version }}
          path: db.sqlite3
          retention-days: 7

  # Job 6: Static Files Collection
  static-files:
    name: Collect Static Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Collect Static Files
        run: python manage.py collectstatic --no-input --clear
        env:
          SECRET_KEY: ${{ env.SECRET_KEY }}
      
      - name: Upload Static Files
        uses: actions/upload-artifact@v4
        with:
          name: static-files
          path: staticfiles/
          retention-days: 7

  # Job 7: Build Summary
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, security, django-checks, migrations, test, static-files]
    if: always()
    
    steps:
      - name: Check All Jobs Status
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Django Checks | ${{ needs.django-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Migrations | ${{ needs.migrations.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Files | ${{ needs.static-files.result }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail if Required Jobs Failed
        if: |
          needs.lint.result == 'failure' ||
          needs.django-checks.result == 'failure' ||
          needs.migrations.result == 'failure' ||
          needs.test.result == 'failure'
        run: |
          echo "::error::Required CI jobs failed"
          exit 1
